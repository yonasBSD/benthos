name: Integration Tests

on:
  schedule:
    # Run every day at 1AM UTC
    - cron: '0 1 * * *'
  pull_request:
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      package:
        description: 'Package to test (e.g. ./internal/impl/aws). Leave empty to run all.'
        required: false
        default: ''
        type: string

jobs:
  integration-test:
    if: ${{ github.event_name != 'issue_comment' && github.event.inputs.package == '' && (github.event_name != 'pull_request' || startsWith(github.event.pull_request.title, 'build(deps)')) }}
    runs-on: ubuntu-latest-32
    env:
      CGO_ENABLED: 0
    strategy:
      fail-fast: false
      matrix:
        package:
          - ./internal/impl/amqp09
          - ./internal/impl/amqp1
          - ./internal/impl/aws
          # - ./internal/impl/azure
          # - ./internal/impl/beanstalkd
          - ./internal/impl/cassandra
          - ./internal/impl/cockroachdb
          # - ./internal/impl/couchbase
          - ./internal/impl/elasticsearch/v8
          - ./internal/impl/elasticsearch/v9
          # - ./internal/impl/gcp
          - ./internal/impl/gcp/enterprise
          # - ./internal/impl/gcp/enterprise/changestreams
          # - ./internal/impl/gcp/enterprise/changestreams/metadata
          - ./internal/impl/hdfs
          - ./internal/impl/influxdb
          # - ./internal/impl/kafka
          - ./internal/impl/kafka/enterprise
          - ./internal/impl/memcached
          - ./internal/impl/mssqlserver
          - ./internal/impl/mongodb
          - ./internal/impl/mongodb/cdc
          # - ./internal/impl/mqtt
          - ./internal/impl/mysql
          # - ./internal/impl/nanomsg
          # - ./internal/impl/nats
          - ./internal/impl/nsq
          - ./internal/impl/opensearch
          - ./internal/impl/postgresql
          - ./internal/impl/pulsar
          - ./internal/impl/qdrant
          # - ./internal/impl/questdb
          - ./internal/impl/redis
          - ./internal/impl/redpanda/migrator
          - ./internal/impl/sftp
          # - ./internal/impl/snowflake
          - ./internal/impl/snowflake/streaming
          # - ./internal/impl/splunk
          # - ./internal/impl/sql

          # Requires CGO_ENABLED=1
          # - ./internal/impl/tigerbeetle
          # - ./internal/impl/zeromq

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Install Go
        uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'

      - name: Install Task
        uses: ./.github/actions/setup-task

      - name: Pull Latest Redpanda Image
        run: task docker:pull-redpanda

      - name: Run Integration Tests for ${{ matrix.package }}
        run: task test:integration-package PKG=${{ matrix.package }}
        timeout-minutes: 30

  integration-test-package:
    if: >-
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && startsWith(github.event.comment.body, '/test ')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.package != '')
    runs-on: ubuntu-latest-32
    env:
      CGO_ENABLED: 0
    steps:
      - name: Check commenter permissions
        if: ${{ github.event_name == 'issue_comment' }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PERMISSION=$(gh api "repos/${{ github.repository }}/collaborators/${{ github.event.comment.user.login }}/permission" --jq '.permission')
          if [[ "${PERMISSION}" != "admin" && "${PERMISSION}" != "write" ]]; then
            echo "::error::User ${{ github.event.comment.user.login }} does not have write access"
            exit 1
          fi

      - name: Parse package from comment
        if: ${{ github.event_name == 'issue_comment' }}
        id: parse
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          PACKAGE=$(echo "${COMMENT_BODY}" | sed 's|^/test ||')
          echo "package=${PACKAGE}" >> "$GITHUB_OUTPUT"

      - name: Checkout PR branch
        if: ${{ github.event_name == 'issue_comment' }}
        uses: actions/checkout@v5
        with:
          ref: refs/pull/${{ github.event.issue.number }}/merge

      - name: Checkout code
        if: ${{ github.event_name != 'issue_comment' }}
        uses: actions/checkout@v5

      - name: Install Go
        uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'

      - name: Install Task
        uses: ./.github/actions/setup-task

      - name: Pull Latest Redpanda Image
        run: task docker:pull-redpanda

      - name: Run Integration Tests
        env:
          PACKAGE: ${{ steps.parse.outputs.package || github.event.inputs.package }}
        run: task test:integration-package PKG="${PACKAGE}"
        timeout-minutes: 30
